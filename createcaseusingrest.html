<!DOCTYPE html>
<html>
<head>
    <title>Web-to-Case with File Upload</title>
</head>
<body>
    <h1>Web-to-Case with File Upload</h1>
    <form onsubmit="event.preventDefault(); createCaseWithAttachment();">
        <label for="name">Contact Name</label>
        <input  id="name" maxlength="80" name="name" size="20" type="text" /><br>

        <label for="email">Email</label>
        <input  id="email" maxlength="80" name="email" size="20" type="text" /><br>
        
        <label for="phone">Phone</label>
        <input  id="phone" maxlength="40" name="phone" size="20" type="text" /><br>

        <label for="subject">Subject:</label>
        <input type="text" id="subject" required><br>

        <label for="description">Description:</label><br>
        <textarea id="description" rows="4" cols="50"></textarea><br>

        <label for="file">Attachment:</label>
        <input type="file" id="file" accept=".jpg, .jpeg, .png, .pdf" required><br>

        <button type="submit">Submit</button>
    </form>

    <script>
        async function createCaseWithAttachment() {
            const caseData = {
                'Subject': document.getElementById('subject').value,
                'Description': document.getElementById('description').value,
                // Add other case fields as needed
            };

            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            const fileData = new FormData();
            fileData.append('file', file, file.name);

            try {
                // Create case first
                const caseResponse = await fetch(
                    'https://d5i00000cynaleal-dev-ed.develop.lightning.force.com/services/data/v54.0/sobjects/Case/',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer YOUR_ACCESS_TOKEN',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(caseData)
                    }
                );
                if (!caseResponse.ok) {
                    throw new Error('Failed to create case');
                }

                const caseResponseData = await caseResponse.json();
                const caseId = caseResponseData.id;

                // Then attach file to case
                fileData.set('parentId', caseId);
                fileData.set('Name', file.name);
                fileData.set('Content-Type', file.type);

                const attachmentResponse = await fetch(
                    `https://d5i00000cynaleal-dev-ed.develop.lightning.force.com/services/data/v54.0/sobjects/Attachment/`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer YOUR_ACCESS_TOKEN'
                        },
                        body: fileData
                    }
                );
                if (!attachmentResponse.ok) {
                    throw new Error('Failed to attach file to case');
                }

                console.log('Case and attachment created successfully');
                alert('Case and attachment created successfully!');
            } catch (error) {
                console.error('Error creating case or attachment:', error);
                alert('Error creating case or attachment. Please check the console for details.');
            }
        }
    </script>
</body>
</html>
